{{#extends 'base'}}
 
{{#block 'content'}}
    <h1>Create a new Product</h1>
    <form method="POST">
        {{{form}}}
        <div>
             <a href="#" class="btn btn-primary" id="upload_widget">Upload</a>
             <img src="" style="display:none" id="uploaded_image"/>
        </div>
        <input type="submit" class="btn btn-primary mt-3"/>
        <input type="hidden" name="_csrf" value="{{csrfToken}}"/>
    </form>
    

{{/block}}

{{/extends}}


{{#block 'js'}}
<!-- initialise cloudinary -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js" integrity="sha512-bZS47S7sPOxkjU/4Bt0zrhEtWx0y0CRkhEp8IckzK+ltifIIE9EMIMTuT/mEzoIMewUINruDBIR/jJnbguonqQ==" crossorigin="anonymous"></script>

<script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>

<!-- get signature -->
<script>
function generateSignature(callback,params_to_sign){
  axios.get('/cloudinary/sign',{
    params:{
      params_to_sign
    }
  }).then(function(response){
    callback(response.data);
  })
}


// create the upload widget 
//const myWidget = cloudinary.createUploadWidget({
//    cloudName: '{{cloudinaryName}}',
//    apiKey: '{{cloudinaryApiKey}}',
//    uploadPreset: '{{cloudinaryPreset}}',
//    uploadSignature: generateSignature
//  }, (error, result) => {
//    if (!error && result && result.event === "success") {
//      console.log('Done! Here is the image info: ', result.info);
//      // hide the upload widget 
//      document.querySelector('#upload_widget').style.display="none";

      // display the image
//      document.querySelector('#id_image_url').value = result.info.url;
//      document.querySelector('#uploaded_image').src = result.info.url;
//      document.querySelector('#uploaded_image').style.display = 'inline';
//    }
//  }
//)

const myWidget = cloudinary.createUploadWidget(cloudinaryConfig, function(error, result){
        // check if there is no error and there is a result, and the event of the result
        // is a successful upload
        if (!error && result && result.event == 'success') {
            let url = result.info.secure_url;
            // set the value of the hidden form field `image_url` to be
            // the URL of the uploaded image
            document.querySelector('#id_image_url').value = url;
        }
    });


<!-- add event listener to initalise the widget -->
document.getElementById("upload_widget").addEventListener("click", function(){
    myWidget.open();
  }, false);
</script>

{{/block}}
